<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin Dashboard - A.S Tour & Travels</title>
  <!-- Material Icons -->
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    :root {
      /* Defaults (Dark Mode) */
      --bg-dark: #0f172a;
      --bg-card: #1e293b;
      --text-main: #f1f5f9;
      --text-muted: #94a3b8;
      --accent: #38bdf8;
      --accent-green: #10b981;
      --border: #334155;
      --input-bg: #0f172a;
      --table-header: rgba(0, 0, 0, 0.2);
    }

    :root.light-mode {
      --bg-dark: #f8fafc;
      --bg-card: #ffffff;
      --text-main: #0f172a;
      --text-muted: #64748b;
      --accent: #0ea5e9;
      --accent-green: #059669;
      --border: #e2e8f0;
      --input-bg: #f1f5f9;
      --table-header: #f1f5f9;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: var(--bg-dark);
      color: var(--text-main);
      display: flex;
      min-height: 100vh;
      overflow-x: hidden;
      transition: background-color 0.3s, color 0.3s;
    }

    /* --- SIDEBAR --- */
    .sidebar {
      width: 260px;
      background-color: var(--bg-card);
      border-right: 1px solid var(--border);
      position: fixed;
      top: 0;
      bottom: 0;
      left: 0;
      z-index: 100;
      display: flex;
      flex-direction: column;
    }

    .brand {
      height: 70px;
      display: flex;
      align-items: center;
      padding: 0 24px;
      font-size: 20px;
      font-weight: 700;
      color: var(--accent);
      border-bottom: 1px solid var(--border);
      gap: 10px;
    }

    .nav-menu {
      padding: 20px 10px;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px 20px;
      border-radius: 8px;
      color: var(--text-muted);
      text-decoration: none;
      font-weight: 500;
      font-size: 14px;
      transition: all 0.2s;
      cursor: pointer;
      border: none;
      background: none;
      width: 100%;
      text-align: left;
    }

    .nav-item:hover,
    .nav-item.active {
      background-color: rgba(56, 189, 248, 0.1);
      color: var(--accent);
    }

    .nav-item .material-icons-round {
      font-size: 20px;
    }

    .bottom-menu {
      padding: 20px;
      border-top: 1px solid var(--border);
    }

    .btn-logout {
      width: 100%;
      padding: 12px;
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.2);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }

    .btn-logout:hover {
      background: rgba(239, 68, 68, 0.2);
    }

    /* --- MAIN CONTENT --- */
    .main-content {
      margin-left: 260px;
      flex: 1;
      padding: 40px;
    }

    .header {
      margin-bottom: 40px;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      color: white;
      margin-bottom: 10px;
    }

    .header p {
      color: var(--text-muted);
      font-size: 14px;
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 24px;
      margin-bottom: 40px;
    }

    .stat-card {
      background-color: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 24px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .stat-title {
      color: var(--text-muted);
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: white;
      margin-top: 8px;
    }

    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }

    .icon-blue {
      background: rgba(56, 189, 248, 0.2);
      color: var(--accent);
    }

    .icon-green {
      background: rgba(16, 185, 129, 0.2);
      color: var(--accent-green);
    }

    .icon-orange {
      background: rgba(245, 158, 11, 0.2);
      color: #f59e0b;
    }

    /* Section Actions */
    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      color: white;
    }

    .btn-add {
      background-color: var(--accent);
      color: #0f172a;
      padding: 10px 20px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn-add:hover {
      filter: brightness(110%);
    }

    /* Card Grid for Items */
    .item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 24px;
    }

    .item-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .item-image {
      width: 100%;
      height: 200px;
      object-fit: cover;
      background: #334155;
    }

    .item-content {
      padding: 20px;
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .item-title {
      font-size: 18px;
      font-weight: 700;
      color: white;
      margin-bottom: 5px;
    }

    .item-meta {
      color: var(--text-muted);
      font-size: 14px;
      margin-bottom: 15px;
    }

    .item-price {
      font-size: 16px;
      color: var(--accent);
      font-weight: 700;
    }

    .item-actions {
      margin-top: auto;
      display: flex;
      gap: 10px;
    }

    .btn-action {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
    }

    .btn-action:hover {
      background: rgba(255, 255, 255, 0.05);
      color: white;
    }

    .btn-delete {
      color: #ef4444;
      border-color: rgba(239, 68, 68, 0.3);
    }

    .btn-delete:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    /* Tables */
    .table-container {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th {
      text-align: left;
      padding: 16px;
      background: var(--table-header);
      color: var(--text-muted);
      font-size: 12px;
      text-transform: uppercase;
      font-weight: 600;
    }

    td {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      color: var(--text-main);
      font-size: 14px;
    }

    tr:last-child td {
      border-bottom: none;
    }

    /* Form Elements */
    input,
    select {
      width: 100%;
      background: var(--input-bg);
      border: 1px solid var(--border);
      padding: 12px;
      border-radius: 8px;
      color: var(--text-main);
      margin-bottom: 10px;
      outline: none;
      transition: all 0.3s;
    }

    input:focus {
      border-color: var(--accent);
      background: var(--bg-card);
    }

    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .modal-overlay.open {
      opacity: 1;
      pointer-events: auto;
    }

    .modal-box {
      background: var(--bg-card);
      width: 90%;
      max-width: 500px;
      padding: 30px;
      border-radius: 12px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5);
    }

    /* Utilities */
    .hidden {
      display: none;
    }

    .badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
    }

    .badge-active {
      background: rgba(16, 185, 129, 0.2);
      color: var(--accent-green);
    }

    .badge-inactive {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }
  </style>
</head>

<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">
      <span class="material-icons-round">flight_takeoff</span>
      <span>A.S Admin</span>
    </div>

    <nav class="nav-menu">
      <button onclick="switchView('dashboard')" class="nav-item active" id="nav-dashboard">
        <span class="material-icons-round">dashboard</span> Dashboard
      </button>
      <button onclick="switchView('packages')" class="nav-item" id="nav-packages">
        <span class="material-icons-round">inventory_2</span> Packages
      </button>
      <button onclick="switchView('fleet')" class="nav-item" id="nav-fleet">
        <span class="material-icons-round">directions_car</span> Fleet
      </button>
      <button onclick="switchView('enquiries')" class="nav-item" id="nav-enquiries">
        <span class="material-icons-round">mail</span> Enquiries
      </button>
      <button onclick="switchView('testimonials')" class="nav-item" id="nav-testimonials">
        <span class="material-icons-round">reviews</span> Testimonials
      </button>
      <button onclick="switchView('settings')" class="nav-item" id="nav-settings">
        <span class="material-icons-round">settings</span> Settings
      </button>
    </nav>

    <div class="bottom-menu">
      <button onclick="toggleTheme()" class="nav-item" id="btn-theme-toggle" style="margin-bottom: 10px;">
        <span class="material-icons-round">light_mode</span> <span id="theme-text">Light Mode</span>
      </button>
      <button onclick="logoutAdmin()" class="btn-logout">Sign Out</button>
    </div>
  </aside>

  <!-- MAIN AREA -->
  <main class="main-content">

    <div class="header">
      <h1 id="page-title">Dashboard Overview</h1>
      <p id="page-subtitle">Welcome back, Admin.</p>
    </div>

    <!-- VIEW: DASHBOARD -->
    <div id="view-dashboard" class="content-section">
      <div class="stats-grid">
        <!-- Stat 1 -->
        <div class="stat-card">
          <div>
            <div class="stat-title">Total Packages</div>
            <div class="stat-value" id="stat-pkg">0</div>
          </div>
          <div class="stat-icon icon-blue">
            <span class="material-icons-round">inventory_2</span>
          </div>
        </div>
        <!-- Stat 2 -->
        <div class="stat-card">
          <div>
            <div class="stat-title">Fleet Size</div>
            <div class="stat-value" id="stat-fleet">0</div>
          </div>
          <div class="stat-icon icon-green">
            <span class="material-icons-round">directions_car</span>
          </div>
        </div>
        <!-- Stat 3 -->
        <div class="stat-card">
          <div>
            <div class="stat-title">Enquiries</div>
            <div class="stat-value" id="stat-enq">0</div>
          </div>
          <div class="stat-icon icon-orange">
            <span class="material-icons-round">mail</span>
          </div>
        </div>
      </div>
    </div>

    <!-- VIEW: PACKAGES -->
    <div id="view-packages" class="content-section hidden">
      <div class="section-header">
        <div class="section-title">All Packages</div>
        <button onclick="openModal('package')" class="btn-add">
          <span class="material-icons-round" style="font-size: 18px;">add</span> Add Package
        </button>
      </div>
      <div id="packages-container" class="item-grid"></div>
    </div>

    <!-- VIEW: FLEET -->
    <div id="view-fleet" class="content-section hidden">
      <div class="section-header">
        <div class="section-title">Vehicle Fleet</div>
        <button onclick="openModal('fleet')" class="btn-add">
          <span class="material-icons-round" style="font-size: 18px;">add</span> Add Vehicle
        </button>
      </div>
      <div id="fleet-container" class="item-grid"></div>
    </div>

    <!-- VIEW: ENQUIRIES -->
    <div id="view-enquiries" class="content-section hidden">
      <div class="section-header">
        <div class="section-title">Enquiries & Bookings</div>
      </div>

      <div style="margin-bottom: 30px;">
        <h3
          style="color: var(--text-muted); margin-bottom: 10px; font-size: 14px; text-transform: uppercase; font-weight: 600;">
          General Enquiries</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Contact</th>
                <th>Service</th>
                <th>Info / Route</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="general-enquiries-table"></tbody>
          </table>
        </div>
      </div>

      <div style="margin-bottom: 30px;">
        <h3
          style="color: var(--text-muted); margin-bottom: 10px; font-size: 14px; text-transform: uppercase; font-weight: 600;">
          Rail Bookings</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Contact</th>
                <th>Route</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="rail-table"></tbody>
          </table>
        </div>
      </div>

      <div>
        <h3
          style="color: var(--text-muted); margin-bottom: 10px; font-size: 14px; text-transform: uppercase; font-weight: 600;">
          Flight Bookings</h3>
        <div class="table-container" style="margin-bottom: 30px;">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Contact</th>
                <th>Route</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="flight-table"></tbody>
          </table>
        </div>
      </div>

      <div>
        <h3
          style="color: var(--text-muted); margin-bottom: 10px; font-size: 14px; text-transform: uppercase; font-weight: 600;">
          Cab Bookings</h3>
        <div class="table-container" style="margin-bottom: 30px;">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Contact</th>
                <th>Vehicle</th>
                <th>Pickup → Drop</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="cab-bookings-table"></tbody>
          </table>
        </div>
      </div>

      <div>
        <h3
          style="color: var(--text-muted); margin-bottom: 10px; font-size: 14px; text-transform: uppercase; font-weight: 600;">
          Package Bookings</h3>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Name</th>
                <th>Contact</th>
                <th>Package</th>
                <th>Travelers</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="pkg-bookings-table"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- VIEW: TESTIMONIALS -->
    <div id="view-testimonials" class="content-section hidden">
      <div class="section-header">
        <div class="section-title">Client Testimonials</div>
        <button onclick="openModal('testimonial')" class="btn-add">
          <span class="material-icons-round" style="font-size: 18px;">add</span> Add Testimonial
        </button>
      </div>
      <div id="testimonials-container" class="item-grid"></div>
    </div>

    <!-- VIEW: SETTINGS -->
    <div id="view-settings" class="content-section hidden">
      <div class="stat-card" style="display: block; max-width: 600px;">
        <h2 style="font-size: 18px; color: white; margin-bottom: 20px;">Payment Configuration</h2>
        <form id="settings-form">
          <label style="display: block; margin-bottom: 8px; font-size: 14px; color: var(--text-muted);">UPI QR Code
            URL</label>
          <div style="display: flex; gap: 10px; margin-bottom: 10px;">
            <input type="url" id="upi-qr-url" placeholder="https://..." required style="margin-bottom: 0;">
            <button type="button" onclick="updateQrPreview()" class="btn-action"
              style="flex: 0 0 auto; width: auto; border: 1px solid var(--border);">Preview</button>
          </div>

          <div style="margin: 20px 0; background: #fff; padding: 10px; border-radius: 8px; width: fit-content;">
            <img id="qr-preview" style="max-width: 150px; display: none;">
            <div id="qr-placeholder"
              style="width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; color: #333; font-size: 12px;">
              No QR Set</div>
          </div>

          <button class="btn-add" style="width: 100%; justify-content: center;">Save Settings</button>
        </form>
      </div>
    </div>

  </main>

  <!-- MODAL -->
  <div id="modal-overlay" class="modal-overlay">
    <div class="modal-box">
      <div style="display: flex; justify-content: space-between; margin-bottom: 20px;">
        <h3 id="modal-title" style="color: white; font-size: 20px; font-weight: 700;">Add Item</h3>
        <button onclick="closeModal()"
          style="background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 24px;">&times;</button>
      </div>
      <form id="modal-form"></form>
    </div>
  </div>

  <script type="module">
    import { db, auth, storage } from '../js/firebase.js';
    import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
    import { collection, onSnapshot, addDoc, deleteDoc, doc, updateDoc, setDoc, getDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
    import { ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js";

    // --- Navigation Logic ---
    window.switchView = (id) => {
      // Hide all sections
      document.querySelectorAll('.content-section').forEach(el => el.classList.add('hidden'));
      // Show target
      document.getElementById(`view-${id}`).classList.remove('hidden');

      // Update sidebar
      document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
      document.getElementById(`nav-${id}`).classList.add('active');

      const titles = {
        'dashboard': 'Dashboard Overview',
        'packages': 'Manage Packages',
        'fleet': 'Fleet Management',
        'enquiries': 'Customer Enquiries',
        'testimonials': 'Client Testimonials',
        'settings': 'System Settings'
      };
      document.getElementById('page-title').textContent = titles[id];
    };

    // --- State ---
    let state = { pkgs: [], fleet: [], rail: [], flight: [], testimonials: [], cabBookings: [], pkgBookings: [], enquiries: [] };

    function render() {
      // Stats
      document.getElementById('stat-pkg').textContent = state.pkgs.length;
      document.getElementById('stat-fleet').textContent = state.fleet.length;
      document.getElementById('stat-enq').textContent = state.rail.length + state.flight.length + state.enquiries.length;

      // Packages
      document.getElementById('packages-container').innerHTML = state.pkgs.map(p => `
        <div class="item-card">
          <img src="${p.image || 'https://via.placeholder.com/400'}" class="item-image">
          <div class="item-content">
            <div class="item-title">${p.title}</div>
            <div class="item-meta">${p.duration} Days</div>
            <div class="item-price">₹${p.price}</div>
            <div class="item-actions">
               <button onclick="window.deleteItem('packages','${p.id}')" class="btn-action btn-delete">Delete</button>
            </div>
          </div>
        </div>
      `).join('');

      // Fleet
      document.getElementById('fleet-container').innerHTML = state.fleet.map(c => `
        <div class="item-card">
           <div style="position: relative;">
              <img src="${c.image || 'https://via.placeholder.com/400'}" class="item-image" style="object-fit: contain; background: #fff; padding: 20px;">
              <span class="badge ${c.status === 'active' ? 'badge-active' : 'badge-inactive'}" style="position: absolute; top: 10px; right: 10px;">${c.status}</span>
           </div>
          <div class="item-content">
            <div class="item-title">${c.title}</div>
            <div class="item-meta">${c.carType} • ${c.seats} Seats</div>
            <div class="item-price">₹${c.price}/km</div>
            <div class="item-actions">
               <button onclick="window.editCab('${c.id}')" class="btn-action">Edit</button>
               <button onclick="window.deleteItem('cabs','${c.id}')" class="btn-action btn-delete">Delete</button>
            </div>
          </div>
        </div>
      `).join('');

      // Enquiries Helper
      const renderTable = (list, id, isEnquiry = false) => {
        const el = document.getElementById(id);
        if (!el) return;
        el.innerHTML = list.map(i => `
          <tr>
            <td><div style="font-weight: 500; color: white;">${i.name || i.customerName}</div></td>
            <td>${i.phone || i.customerPhone}</td>
            <td>${isEnquiry ? `<span class="badge" style="background:var(--accent); color:var(--primary);">${i.travelType || 'General'}</span>` : (i.cabTitle || i.packageTitle || (i.from + ' → ' + i.to))}</td>
            <td>${isEnquiry ? (i.pickup ? `${i.pickup} → ${i.drop}` : 'N/A') : (i.travelers ? i.travelers + ' Persons' : (i.pickup ? i.pickup + ' → ' + i.drop : 'N/A'))}</td>
            <td style="color: var(--text-muted); font-size: 13px;">${i.timestamp?.toDate ? i.timestamp.toDate().toLocaleDateString() : 'N/A'}</td>
          </tr>
        `).join('') || `<tr><td colspan="5" style="text-align:center; color: var(--text-muted);">No entries found</td></tr>`;
      };

      // Render Tables
      renderTable(state.enquiries, 'general-enquiries-table', true);
      renderTable(state.rail, 'rail-table');
      renderTable(state.flight, 'flight-table');
      renderTable(state.cabBookings, 'cab-bookings-table');
      renderTable(state.pkgBookings, 'pkg-bookings-table');

      // Testimonials
      document.getElementById('testimonials-container').innerHTML = state.testimonials.map(t => `
        <div class="item-card">
          <div style="padding: 20px; display: flex; align-items: center; gap: 15px; border-bottom: 1px solid var(--border);">
            <img src="${t.photo || 'https://via.placeholder.com/150'}" style="width: 50px; height: 50px; border-radius: 50%; object-fit: cover;">
            <div>
              <div style="color: var(--text-main); font-weight: 600;">${t.name}</div>
              <div style="color: var(--text-muted); font-size: 12px;">${t.city || 'Traveler'}</div>
            </div>
          </div>
          <div class="item-content">
             <div style="color: #f59e0b; margin-bottom: 10px;">${'★'.repeat(t.rating || 5)}${'☆'.repeat(5 - (t.rating || 5))}</div>
             <p style="color: var(--text-muted); font-size: 14px; line-height: 1.5; font-style: italic;">"${t.review}"</p>
             <div class="item-actions" style="margin-top: 15px;">
                <button onclick="window.deleteItem('testimonials','${t.id}')" class="btn-action btn-delete">Delete</button>
             </div>
          </div>
        </div>
      `).join('');
    }

    // --- Modal & Actions ---
    window.openModal = (type) => {
      const overlay = document.getElementById('modal-overlay');
      const form = document.getElementById('modal-form');
      const title = document.getElementById('modal-title');
      overlay.classList.add('open');

      if (type === 'package') {
        title.textContent = 'Add Package';
        form.innerHTML = `
          <input id="p-title" placeholder="Package Title" required>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
             <input type="number" id="p-price" placeholder="Price (₹)" required>
             <input type="number" id="p-days" placeholder="Duration (Days)" required>
          </div>
          <input id="p-image" placeholder="Image URL">
          <button class="btn-add" style="width: 100%; justify-content: center; margin-top: 10px;">Create Package</button>
        `;
        form.onsubmit = async (e) => {
          e.preventDefault();
          const btn = form.querySelector('button');
          const originalText = btn.textContent;
          btn.textContent = 'Saving...';
          btn.disabled = true;

          try {
            await addDoc(collection(db, 'packages'), {
              title: document.getElementById('p-title').value,
              price: Number(document.getElementById('p-price').value),
              duration: Number(document.getElementById('p-days').value),
              image: document.getElementById('p-image').value,
              createdAt: new Date()
            });
            closeModal();
            alert("Package added successfully!");
          } catch (error) {
            console.error("Error adding package:", error);
            if (error.code === 'permission-denied') {
              alert("PERMISSION DENIED: Unable to save to database.\n\nYour Firestore Security Rules are blocking this request.\n\nPlease go to Firebase Console > Firestore Database > Rules and change them to:\n\nallow read, write: if request.auth != null;");
            } else {
              alert("Failed to add package: " + error.message);
            }
          } finally {
            btn.textContent = originalText;
            btn.disabled = false;
          }
        };
      } else if (type === 'fleet') {
        title.textContent = 'Add Vehicle';
        form.innerHTML = `
          <input id="c-title" placeholder="Vehicle Name" required>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
             <input type="number" id="c-price" placeholder="Rate/km" required>
             <input type="number" id="c-seats" placeholder="Seats" required>
          </div>
          <select id="c-type">
             <option>Sedan</option><option>SUV</option><option>Hatchback</option><option>Luxury</option><option>Tempo Traveller</option>
          </select>
          <div style="margin-bottom: 10px;">
             <label style="color:var(--text-muted); font-size:12px; display:block; margin-bottom:5px;">Vehicle Image (Upload or URL)</label>
             <input type="file" id="c-image-file" accept="image/*" style="margin-bottom:5px; padding: 8px;">
             <input id="c-image" placeholder="Or paste Image URL if not uploading">
          </div>
          <div style="display: flex; gap: 15px; margin-bottom: 15px; color: white; font-size: 14px;">
             <label style="display: flex; gap: 5px;"><input type="checkbox" id="c-ac" checked> AC</label>
             <label style="display: flex; gap: 5px;"><input type="checkbox" id="c-active" checked> Active</label>
          </div>
          <button class="btn-add" style="width: 100%; justify-content: center;">Add Vehicle</button>
        `;
        form.onsubmit = async (e) => {
          e.preventDefault();
          const btn = form.querySelector('button');
          const originalText = btn.textContent;
          btn.textContent = 'Saving...';
          btn.disabled = true;

          try {
            let imageUrl = document.getElementById('c-image').value;
            const fileInput = document.getElementById('c-image-file');

            if (fileInput.files.length > 0) {
              btn.textContent = 'Uploading Image...';
              const file = fileInput.files[0];
              const storageRef = ref(storage, 'fleet/' + Date.now() + '_' + file.name);
              await uploadBytes(storageRef, file);
              imageUrl = await getDownloadURL(storageRef);
              btn.textContent = 'Saving Data...';
            }

            await addDoc(collection(db, 'cabs'), {
              title: document.getElementById('c-title').value,
              price: Number(document.getElementById('c-price').value),
              seats: Number(document.getElementById('c-seats').value),
              carType: document.getElementById('c-type').value,
              image: imageUrl,
              ac: document.getElementById('c-ac').checked,
              status: document.getElementById('c-active').checked ? 'active' : 'inactive',
              createdAt: new Date()
            });
            closeModal();
            alert("Vehicle added successfully!");
          } catch (error) {
            console.error("Error adding vehicle:", error);
            if (error.code === 'permission-denied') {
              alert("PERMISSION DENIED: Unable to save to database.\n\nYour Firestore Security Rules are blocking this request.\n\nPlease go to Firebase Console > Firestore Database > Rules and change them to:\n\nallow read, write: if request.auth != null;");
            } else {
              alert("Failed to add vehicle: " + error.message);
            }
          } finally {
            btn.textContent = originalText;
            btn.disabled = false;
          }
        };
      } else if (type === 'testimonial') {
        title.textContent = 'Add Testimonial';
        form.innerHTML = `
          <input id="t-name" placeholder="Client Name" required>
          <input id="t-city" placeholder="City / Location" required>
          <div style="margin-bottom: 10px;">
            <label style="color:var(--text-muted); font-size:12px; display:block; margin-bottom:5px;">Star Rating</label>
            <select id="t-rating">
              <option value="5">⭐⭐⭐⭐⭐ (5 Stars)</option>
              <option value="4">⭐⭐⭐⭐ (4 Stars)</option>
              <option value="3">⭐⭐⭐ (3 Stars)</option>
            </select>
          </div>
          <textarea id="t-review" placeholder="Review Text" rows="4" required style="width: 100%; background: var(--input-bg); border: 1px solid var(--border); padding: 12px; border-radius: 8px; color: var(--text-main); outline: none; transition: all 0.3s; margin-bottom: 10px;"></textarea>
          <div style="margin-bottom: 10px;">
             <label style="color:var(--text-muted); font-size:12px; display:block; margin-bottom:5px;">Client Photo (Upload or URL)</label>
             <input type="file" id="t-image-file" accept="image/*" style="margin-bottom:5px; padding: 8px;">
             <input id="t-image" placeholder="Image URL (optional)">
          </div>
          <button class="btn-add" style="width: 100%; justify-content: center;">Save Testimonial</button>
        `;
        form.onsubmit = async (e) => {
          e.preventDefault();
          const btn = form.querySelector('button');
          btn.textContent = 'Saving...';
          btn.disabled = true;

          try {
            let imageUrl = document.getElementById('t-image').value;
            const fileInput = document.getElementById('t-image-file');

            if (fileInput.files.length > 0) {
              btn.textContent = 'Uploading Image...';
              const file = fileInput.files[0];
              const storageRef = ref(storage, 'testimonials/' + Date.now() + '_' + file.name);
              await uploadBytes(storageRef, file);
              imageUrl = await getDownloadURL(storageRef);
            }

            await addDoc(collection(db, 'testimonials'), {
              name: document.getElementById('t-name').value,
              city: document.getElementById('t-city').value,
              rating: Number(document.getElementById('t-rating').value),
              review: document.getElementById('t-review').value,
              photo: imageUrl,
              createdAt: new Date()
            });
            closeModal();
            alert("Testimonial added successfully!");
          } catch (error) {
            console.error("Error adding testimonial:", error);
            alert("Failed to add testimonial: " + error.message);
          } finally {
            btn.textContent = 'Save Testimonial';
            btn.disabled = false;
          }
        };
      }
    };

    window.editCab = (id) => {
      const c = state.fleet.find(x => x.id === id); if (!c) return;
      const overlay = document.getElementById('modal-overlay');
      const form = document.getElementById('modal-form');
      document.getElementById('modal-title').textContent = 'Edit Vehicle';
      overlay.classList.add('open');

      form.innerHTML = `
          <input id="ec-title" value="${c.title}" required>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
             <input type="number" id="ec-price" value="${c.price}" required>
             <input type="number" id="ec-seats" value="${c.seats || 4}" required>
          </div>
          <select id="ec-type">
             <option ${c.carType === 'Sedan' ? 'selected' : ''}>Sedan</option>
             <option ${c.carType === 'SUV' ? 'selected' : ''}>SUV</option>
             <option ${c.carType === 'Hatchback' ? 'selected' : ''}>Hatchback</option>
             <option ${c.carType === 'Luxury' ? 'selected' : ''}>Luxury</option>
             <option ${c.carType === 'Tempo Traveller' ? 'selected' : ''}>Tempo Traveller</option>
          </select>
          <div style="margin-bottom: 10px;">
             <label style="color:var(--text-muted); font-size:12px; display:block; margin-bottom:5px;">Vehicle Image (Upload or URL)</label>
             <input type="file" id="ec-image-file" accept="image/*" style="margin-bottom:5px; padding: 8px;">
             <input id="ec-image" value="${c.image || ''}" placeholder="Image URL">
          </div>
          <div style="display: flex; gap: 15px; margin-bottom: 15px; color: white; font-size: 14px;">
             <label style="display: flex; gap: 5px;"><input type="checkbox" id="ec-ac" ${c.ac ? 'checked' : ''}> AC</label>
             <label style="display: flex; gap: 5px;"><input type="checkbox" id="ec-active" ${c.status === 'active' ? 'checked' : ''}> Active</label>
          </div>
          <button class="btn-add" style="width: 100%; justify-content: center;">Update Vehicle</button>
        `;
      form.onsubmit = async (e) => {
        e.preventDefault();
        const btn = form.querySelector('button');
        const originalText = btn.textContent;
        btn.textContent = 'Updating...';
        btn.disabled = true;

        try {
          let imageUrl = document.getElementById('ec-image').value;
          const fileInput = document.getElementById('ec-image-file');

          if (fileInput.files.length > 0) {
            btn.textContent = 'Uploading Image...';
            const file = fileInput.files[0];
            const storageRef = ref(storage, 'fleet/' + Date.now() + '_' + file.name);
            await uploadBytes(storageRef, file);
            imageUrl = await getDownloadURL(storageRef);
            btn.textContent = 'Updating Data...';
          }

          await updateDoc(doc(db, 'cabs', id), {
            title: document.getElementById('ec-title').value,
            price: Number(document.getElementById('ec-price').value),
            seats: Number(document.getElementById('ec-seats').value),
            carType: document.getElementById('ec-type').value,
            image: imageUrl,
            ac: document.getElementById('ec-ac').checked,
            status: document.getElementById('ec-active').checked ? 'active' : 'inactive'
          });
          closeModal();
        } catch (error) {
          console.error("Error updating vehicle:", error);
          alert("Failed to update vehicle: " + error.message);
        } finally {
          btn.textContent = originalText;
          btn.disabled = false;
        }
      };
    };

    window.closeModal = () => document.getElementById('modal-overlay').classList.remove('open');
    window.deleteItem = (col, id) => confirm('Delete item?') && deleteDoc(doc(db, col, id));
    window.logoutAdmin = () => signOut(auth).then(() => window.location.href = 'login.html');

    // Init Logic
    // --- Theme Logic ---
    window.toggleTheme = () => {
      const root = document.documentElement;
      const isLight = root.classList.toggle('light-mode');
      const btn = document.getElementById('btn-theme-toggle');
      const text = document.getElementById('theme-text');
      const icon = btn.querySelector('.material-icons-round');

      if (isLight) {
        localStorage.setItem('theme', 'light');
        icon.textContent = 'dark_mode';
        text.textContent = 'Dark Mode';
      } else {
        localStorage.setItem('theme', 'dark');
        icon.textContent = 'light_mode';
        text.textContent = 'Light Mode';
      }
    };

    // Load Theme
    if (localStorage.getItem('theme') === 'light') {
      window.toggleTheme(); // This will toggle it ON since it starts OFF
    }

    // --- QR Preview Logic ---
    window.updateQrPreview = () => {
      const url = document.getElementById('upi-qr-url').value;
      const img = document.getElementById('qr-preview');
      const placeholder = document.getElementById('qr-placeholder');

      if (url) {
        img.src = url;
        img.style.display = 'block';
        placeholder.style.display = 'none';

        img.onerror = () => {
          img.style.display = 'none';
          placeholder.style.display = 'flex';
          placeholder.textContent = 'Invalid Image URL';
        };
      } else {
        img.style.display = 'none';
        placeholder.style.display = 'flex';
        placeholder.textContent = 'No QR Set';
      }
    };

    // Init Logic
    onAuthStateChanged(auth, u => {
      if (!u) window.location.href = 'login.html';
      else {
        // Use onSnapshot for settings for real-time updates
        onSnapshot(doc(db, 'settings', 'payment'), (docSnap) => {
          if (docSnap.exists() && docSnap.data().qrUrl) {
            const url = docSnap.data().qrUrl;
            document.getElementById('upi-qr-url').value = url;
            // Only update preview if the user isn't currently typing (simple check omitted, but syncs on load)
            if (document.activeElement !== document.getElementById('upi-qr-url')) {
              const img = document.getElementById('qr-preview');
              const placeholder = document.getElementById('qr-placeholder');
              img.src = url;
              img.style.display = 'block';
              placeholder.style.display = 'none';
            }
          }
        });

        onSnapshot(collection(db, 'packages'), s => { state.pkgs = s.docs.map(d => ({ id: d.id, ...d.data() })); render(); });
        onSnapshot(collection(db, 'cabs'), s => { state.fleet = s.docs.map(d => ({ id: d.id, ...d.data() })); render(); });
        onSnapshot(query(collection(db, 'rail_enquiries'), orderBy('timestamp', 'desc')), s => { state.rail = s.docs.map(d => ({ id: d.id, ...d.data() })); render(); });
        onSnapshot(query(collection(db, 'flight_enquiries'), orderBy('timestamp', 'desc')), s => { state.flight = s.docs.map(d => ({ id: d.id, ...d.data() })); render(); });
        onSnapshot(query(collection(db, 'bookings'), orderBy('timestamp', 'desc')), s => { state.cabBookings = s.docs.map(d => ({ id: d.id, ...d.data() })); render(); });
        onSnapshot(query(collection(db, 'package_bookings'), orderBy('timestamp', 'desc')), s => { state.pkgBookings = s.docs.map(d => ({ id: d.id, ...d.data() })); render(); });
        onSnapshot(query(collection(db, 'enquiries'), orderBy('timestamp', 'desc')), s => { state.enquiries = s.docs.map(d => ({ id: d.id, ...d.data() })); render(); });
        onSnapshot(collection(db, 'testimonials'), s => { state.testimonials = s.docs.map(d => ({ id: d.id, ...d.data() })); render(); });

        document.getElementById('settings-form').addEventListener('submit', async (e) => {
          e.preventDefault();
          const btn = e.target.querySelector('button[type="submit"]');
          const originalText = btn.textContent;
          btn.textContent = 'Saving...';
          btn.disabled = true;

          try {
            const url = document.getElementById('upi-qr-url').value;
            // Update the preview immediately
            window.updateQrPreview();

            // Try to write
            await setDoc(doc(db, 'settings', 'payment'), { qrUrl: url }, { merge: true });
            alert('Settings Saved Successfully!');
          } catch (err) {
            console.error("Save Error:", err);
            if (err.code === 'permission-denied') {
              alert('ERROR: Permission Denied.\nYou do not have permission to edit settings.\nPlease update Firestore Rules to allow writes to "settings/payment".');
            } else {
              alert('Error saving settings: ' + err.message);
            }
          } finally {
            btn.textContent = originalText;
            btn.disabled = false;
          }
        });
      }
    });

  </script>
</body>

</html>